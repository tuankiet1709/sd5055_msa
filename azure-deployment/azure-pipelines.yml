# Azure Pipeline for deploying to AKS
# This pipeline deploys frontend and backend containers to Azure Kubernetes Service

trigger: none  # Manual trigger only for deployment pipeline

parameters:
- name: frontendImageTag
  displayName: 'Frontend Image Tag'
  type: string
  default: 'latest'
  
- name: backendImageTag
  displayName: 'Backend Image Tag'
  type: string
  default: 'latest'

variables:
  acrName: 'sd5055practicaldevopsregistry'
  aksCluster: 'sd5055-azure-cicd-pipeline-aks'
  aksResourceGroup: 'sd5055-azure-cicd-pipeline-dev-rg'
  namespace: 'sd5055-msa'
  azureSubscription: 'sd5055-service-connection'

pool:
  name: 'Default'

stages:
- stage: Deploy
  displayName: 'Deploy to AKS'
  jobs:
  - job: DeployApp
    displayName: 'Deploy Application'
    steps:
    
    # Install kubectl
    - task: KubectlInstaller@0
      displayName: 'Install kubectl'
      inputs:
        kubectlVersion: 'latest'
    
    # Configure kubectl for AKS
    - task: AzureCLI@2
      displayName: 'Configure kubectl for AKS'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Getting AKS credentials..."
          az aks get-credentials \
            --resource-group $(aksResourceGroup) \
            --name $(aksCluster) \
            --overwrite-existing
          
          echo "Verifying connection..."
          kubectl cluster-info
    
    # Deploy to AKS
    - task: AzureCLI@2
      displayName: 'Deploy application to AKS'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "Deploying with Frontend tag: ${{ parameters.frontendImageTag }} and Backend tag: ${{ parameters.backendImageTag }}"
          
          # Replace ACR name and image tags in the YAML
          sed "s/YOUR_ACR_NAME/$(acrName)/g" azure-deployment/app.yaml | \
          sed "s/sd5055-frontend:latest/sd5055-frontend:${{ parameters.frontendImageTag }}/g" | \
          sed "s/sd5055-backend:latest/sd5055-backend:${{ parameters.backendImageTag }}/g" | \
          kubectl apply -f -
          
          echo "Resources applied successfully"
    
    # Wait for rollout to complete
    - task: Kubernetes@1
      displayName: 'Wait for backend rollout'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionEndpoint: '$(azureSubscription)'
        azureResourceGroup: '$(aksResourceGroup)'
        kubernetesCluster: '$(aksCluster)'
        namespace: '$(namespace)'
        command: 'rollout'
        arguments: 'status deployment/backend --timeout=300s'
    
    - task: Kubernetes@1
      displayName: 'Wait for frontend rollout'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionEndpoint: '$(azureSubscription)'
        azureResourceGroup: '$(aksResourceGroup)'
        kubernetesCluster: '$(aksCluster)'
        namespace: '$(namespace)'
        command: 'rollout'
        arguments: 'status deployment/frontend --timeout=300s'
    
    # Verify deployment
    - task: AzureCLI@2
      displayName: 'Verify deployment'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "======================================"
          echo "Deployment Status"
          echo "======================================"
          
          echo ""
          echo "Pods:"
          kubectl get pods -n $(namespace)
          
          echo ""
          echo "Services:"
          kubectl get svc -n $(namespace)
          
          echo ""
          echo "Getting frontend URL..."
          sleep 10
          FRONTEND_IP=$(kubectl get svc frontend -n $(namespace) -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          
          if [ -n "$FRONTEND_IP" ]; then
            echo "======================================"
            echo "Frontend URL: http://$FRONTEND_IP"
            echo "======================================"
          else
            echo "LoadBalancer IP not ready yet. Check later with: kubectl get svc frontend -n $(namespace)"
          fi

