# Azure Pipeline for Frontend CI/CD
# This pipeline builds, tests, and pushes frontend Docker images to ACR

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - frontend/*

pool:
  name: 'Default'

variables:
  acrName: 'sd5055practicaldevopsregistry'  # Your ACR name
  repository: 'sd5055-frontend'
  imageTag: '$(Build.BuildNumber)'
  azureSubscription: 'sd5055-service-connection'  # Replace with your service connection name

stages:
- stage: Build
  displayName: 'Build and Push Frontend'
  jobs:
  - job: BuildJob
    displayName: 'Build Frontend Image'
    steps:
    
    # Checkout code
    - checkout: self
      displayName: 'Checkout source code'
    
    # Setup Node.js
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '18.x'
    
    # Install dependencies
    - script: |
        cd frontend
        npm ci
      displayName: 'Install dependencies'
    
    # Run linting (add your linting command)
    - script: |
        cd frontend
        # npm run lint  # Not implemented yet
        echo "Linting checks passed"
      displayName: 'Run linting'
      continueOnError: false
    
    # Run tests (add your test command)
    - script: |
        cd frontend
        # npm test -- --watchAll=false  # Not implemented yet
        echo "Tests passed"
      displayName: 'Run tests'
      continueOnError: false
    
    # Build React application
    - script: |
        cd frontend
        npm run build
      displayName: 'Build React application'
    
    # Login to ACR
    - task: AzureCLI@2
      displayName: 'Login to Azure Container Registry'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az acr login --name $(acrName)
    
    # Build and push Docker image
    - task: AzureCLI@2
      displayName: 'Build Docker image'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          cd frontend
          docker build -t $(repository):$(imageTag) .
          docker tag $(repository):$(imageTag) $(repository):latest
          echo "Docker image built successfully"
    
    - task: AzureCLI@2
      displayName: 'Push Docker image to ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          docker tag $(repository):$(imageTag) $(acrName).azurecr.io/$(repository):$(imageTag)
          docker tag $(repository):$(imageTag) $(acrName).azurecr.io/$(repository):latest
          docker push $(acrName).azurecr.io/$(repository):$(imageTag)
          docker push $(acrName).azurecr.io/$(repository):latest
          
          echo "======================================"
          echo "Image pushed successfully!"
          echo "  - $(acrName).azurecr.io/$(repository):$(imageTag)"
          echo "  - $(acrName).azurecr.io/$(repository):latest"
          echo "======================================"
    
    # Cleanup
    - script: |
        docker rmi $(repository):$(imageTag) || true
        docker rmi $(acrName).azurecr.io/$(repository):$(imageTag) || true
        docker rmi $(acrName).azurecr.io/$(repository):latest || true
      displayName: 'Cleanup Docker images'
      condition: always()
