# Azure Pipeline for Backend CI/CD
# This pipeline builds, tests, and pushes backend Docker images to ACR

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - backend/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  acrName: 'sd5055practicaldevopsregistry'
  repository: 'sd5055-backend'
  imageTag: '$(Build.BuildNumber)'
  azureSubscription: 'sd5055-service-connection'

stages:
- stage: Build
  displayName: 'Build and Push Backend'
  jobs:
  - job: BuildJob
    displayName: 'Build Backend Image'
    steps:
    
    # Checkout code
    - checkout: self
      displayName: 'Checkout source code'
    
    # Setup Node.js
    - task: NodeTool@0
      displayName: 'Install Node.js'
      inputs:
        versionSpec: '18.x'
    
    # Install dependencies
    - script: |
        cd backend
        npm ci
      displayName: 'Install dependencies'
    
    # Run linting (add your linting command)
    - script: |
        cd backend
        # npm run lint # Not implemented yet
        echo "Linting checks passed"
      displayName: 'Run linting'
      continueOnError: false
    
    # Run tests (add your test command)
    - script: |
        cd backend
        # npm test  # Not implemented yet
        echo "Tests passed"
      displayName: 'Run tests'
      continueOnError: false
    
    # Login to ACR
    - task: AzureCLI@2
      displayName: 'Login to Azure Container Registry'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az acr login --name $(acrName)
    
    # Build and push Docker image
    - task: Docker@2
      displayName: 'Build Docker image'
      inputs:
        command: 'build'
        repository: '$(repository)'
        dockerfile: 'backend/Dockerfile'
        containerRegistry: '$(acrName).azurecr.io'
        tags: |
          $(imageTag)
          latest
    
    - task: AzureCLI@2
      displayName: 'Push Docker image to ACR'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          docker tag $(repository):$(imageTag) $(acrName).azurecr.io/$(repository):$(imageTag)
          docker tag $(repository):$(imageTag) $(acrName).azurecr.io/$(repository):latest
          docker push $(acrName).azurecr.io/$(repository):$(imageTag)
          docker push $(acrName).azurecr.io/$(repository):latest
          
          echo "======================================"
          echo "Image pushed successfully!"
          echo "  - $(acrName).azurecr.io/$(repository):$(imageTag)"
          echo "  - $(acrName).azurecr.io/$(repository):latest"
          echo "======================================"
    
    # Cleanup
    - script: |
        docker rmi $(repository):$(imageTag) || true
        docker rmi $(acrName).azurecr.io/$(repository):$(imageTag) || true
        docker rmi $(acrName).azurecr.io/$(repository):latest || true
      displayName: 'Cleanup Docker images'
      condition: always()
